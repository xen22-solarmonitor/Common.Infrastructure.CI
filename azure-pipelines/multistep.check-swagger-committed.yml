###############################################################################################
# multistep.check-swagger-committed.yml
###############################################################################################

# This set of steps checks whether the newly generated swagger.json is identical to the one 
# that was committed and if not it fails the build.

parameters:
  apiName:              ''

steps:
  - bash: |
      ls -la $(Build.SourcesDirectory)/src/${{ parameters.apiName }}Proxy/AutoGeneratedSwaggerDefinition/swagger*.json
      SWAGGER_OUTPUT=$(cmp $(System.DefaultWorkingDirectory)/src/${{ parameters.apiName }}Proxy/AutoGeneratedSwaggerDefinition/swagger.json $(Build.SourcesDirectory)/src/${{ parameters.apiName }}Proxy/AutoGeneratedSwaggerDefinition/swagger_prebuild.json)
      export CMP_EXIT_CODE=$?
      if [[ $CMP_EXIT_CODE -ne 0 ]]; then
        # log to stderr
        >&2 echo 'Error: swager.json file is not up to date (it is not in sync with the source code). Please rebuild source tree and commit swagger.json and autogenerated proxy source files. '
        exit $CMP_EXIT_CODE
      fi
    displayName: 'Checking if swagger.json is up to date.'
