###############################################################################################
# archive-steps.yml
###############################################################################################

# this set of steps archives various binaries and other files produced by the build:
# - swagger.json
# - Fully built API source tree
# - API publish directory
# - Proxy Nuget packages (main package and symbol package)
# - API Dockerfile
# - variables saved under the Build stage (to be retrieved by later stages)

parameters:
  buildConfiguration:   'Release'
  apiName:              ''

steps:
  - bash: 'cp $(System.DefaultWorkingDirectory)/src/${{ parameters.apiName }}Proxy/AutoGeneratedSwaggerDefinition/swagger.json $(System.DefaultWorkingDirectory)/swagger_$(GitVersion.SemVer).json'
    displayName: 'Save swagger.json to where it can be archived from (append semVersion to filename)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish generated swagger.json file for this build.'
    inputs:
      pathToPublish: '$(System.DefaultWorkingDirectory)/swagger_$(GitVersion.SemVer).json'
      artifactName: 'swagger'

  - publish: $(System.DefaultWorkingDirectory)/packages
    displayName: 'Archive Nuget packages'
    condition: ne(variables['swaggerChanged'], '0')
    artifact: ProxyNugetPackages
      
  - bash: ls -la $(System.DefaultWorkingDirectory)/src/${{ parameters.apiName }}/bin/${{ parameters.buildConfiguration }}/netcoreapp3.0
    displayName: 'List contents of API bin directory'

  - publish: $(System.DefaultWorkingDirectory)/src/${{ parameters.apiName }}/bin/${{ parameters.buildConfiguration }}/netcoreapp3.0/publish
    displayName: 'Archive API publish directory'
    artifact: ApiBinaries

  - publish: $(System.DefaultWorkingDirectory)/src/${{ parameters.apiName }}/Dockerfile
    displayName: 'Archive API Dockerfile'
    artifact: Dockerfile

    # Note: we cannot publish just the binaries for the unit and integration tests because we also need the source code
#       when we do code coverage
#    - publish: $(System.DefaultWorkingDirectory)/test/unit/Api.Core.SolarMeasurementsUnitTests/bin/${{ parameters.buildConfiguration }}/netcoreapp3.0/publish/
#      displayName: 'Archive Unit test binaries'
#      artifact: UnitTestBinaries
#
#    - publish: $(System.DefaultWorkingDirectory)/test/integration/Api.Core.SolarMeasurementsIntegrationTests/bin/${{ parameters.buildConfiguration }}/netcoreapp3.0/publish/
#      displayName: 'Archive Integration test binaries'
#      artifact: IntegrationTestBinaries

  - publish: $(System.DefaultWorkingDirectory)
    displayName: 'Archive fully built source tree'
    artifact: BuiltSourceTree

    # Publish all variables from this stage as a pipeline artifact
  - publish: $(Pipeline.Workspace)/variables
    displayName: 'Archive Build stage variables for a later stages'
    artifact: variables
